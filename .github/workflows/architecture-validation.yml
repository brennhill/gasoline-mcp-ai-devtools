name: Architecture Validation

on:
  pull_request:
    branches: [main, next, develop]
  push:
    branches: [main, next, develop]

jobs:
  validate-architecture:
    name: Validate Async Queue Architecture
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: Run architecture validation
        run: |
          chmod +x scripts/validate-architecture.sh
          ./scripts/validate-architecture.sh

      - name: Run integration tests
        run: |
          go test -v ./internal/capture -run TestAsyncQueueIntegration -timeout 30s

      - name: Verify pre-commit hook exists
        run: |
          if [ ! -f .git/hooks/pre-commit ]; then
            echo "❌ Pre-commit hook missing!"
            echo "Run: cp .git/hooks/pre-commit.sample .git/hooks/pre-commit"
            exit 1
          fi
          echo "✅ Pre-commit hook exists"

      - name: Check for stub implementations
        run: |
          # Fail if handlers.go returns empty arrays
          if grep -q 'queries.*\[\]interface{}{}' internal/capture/handlers.go; then
            echo "❌ STUB DETECTED in handlers.go"
            exit 1
          fi

          # Fail if toolObserveCommandResult doesn't call GetCommandResult
          if ! grep -A 20 'func (h \*ToolHandler) toolObserveCommandResult' cmd/dev-console/tools.go | grep -q 'GetCommandResult'; then
            echo "❌ STUB DETECTED in toolObserveCommandResult"
            exit 1
          fi

          echo "✅ No stub implementations found"

      - name: Verify critical files unchanged
        if: github.event_name == 'pull_request'
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if critical files were modified
          CRITICAL_FILES=(
            "internal/capture/queries.go"
            "internal/capture/handlers.go"
            "cmd/dev-console/tools.go"
          )

          for file in "${CRITICAL_FILES[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^$file$"; then
              echo "⚠️  WARNING: Critical file modified: $file"
              echo "This PR modifies async queue architecture."
              echo "Ensure you have ADR approval and all enforcement layers are updated."
              echo "See: docs/architecture/ADR-002-async-queue-immutability.md"
            fi
          done

      - name: Summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Architecture validation PASSED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "The async queue-and-poll architecture is intact."
          echo "All critical components are present and functional."

      - name: Failure guidance
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ Architecture validation FAILED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "The async queue-and-poll architecture is broken."
          echo "DO NOT merge this PR."
          echo ""
          echo "See: docs/architecture/ADR-002-async-queue-immutability.md"
          echo "Or ask: 'How do I restore the async queue implementation?'"
          exit 1
