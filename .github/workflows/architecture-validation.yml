name: Architecture Validation

on:
  pull_request:
    branches: [main, next, develop]
  push:
    branches: [main, next, develop]

permissions:
  contents: read

jobs:
  validate-architecture:
    name: Validate Async Queue Architecture
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0  # Fetch full history for merge-base

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.24'
          cache: true

      - name: Run architecture validation
        run: |
          chmod +x scripts/validate-architecture.sh
          ./scripts/validate-architecture.sh

      - name: Run integration tests
        run: |
          go test -v ./internal/capture -run TestAsyncQueueIntegration -timeout 30s

      - name: Verify pre-commit hook exists in repo
        run: |
          if [ ! -f .git/hooks/pre-commit ]; then
            echo "⚠️  WARNING: .git/hooks not populated in CI (expected)"
            echo "Checking if pre-commit hook is tracked in repo..."
          fi
          # In CI, hooks aren't in .git/hooks, just verify the script runs
          if [ -x .git/hooks/pre-commit ]; then
            echo "✅ Pre-commit hook executable"
          else
            echo "ℹ️  Pre-commit hook not in CI checkout (normal for GitHub Actions)"
          fi

      - name: Check for stub implementations
        run: |
          # Fail if handlers.go returns empty arrays
          if grep -q 'queries.*\[\]interface{}{}' internal/capture/handlers.go; then
            echo "❌ STUB DETECTED in handlers.go"
            exit 1
          fi

          # Fail if toolObserveCommandResult doesn't call GetCommandResult.
          # Parse function bodies instead of fixed grep context windows.
          if command -v rg >/dev/null 2>&1; then
            OBSERVE_IMPL_FILES=$(rg -l 'func \(h \*ToolHandler\) toolObserveCommandResult\(' cmd/dev-console/tools_*.go || true)
          else
            OBSERVE_IMPL_FILES=$(grep -El 'func \(h \*ToolHandler\) toolObserveCommandResult\(' cmd/dev-console/tools_*.go 2>/dev/null || true)
          fi
          if [ -z "${OBSERVE_IMPL_FILES:-}" ]; then
            echo "❌ STUB DETECTED in toolObserveCommandResult (implementation missing)"
            exit 1
          fi

          OBSERVE_CALL_OK=0
          for file in $OBSERVE_IMPL_FILES; do
            if awk '
              /func \(h \*ToolHandler\) toolObserveCommandResult\(/ { in_func=1; next }
              in_func && /^func / { in_func=0 }
              in_func && /GetCommandResult\(/ { found=1 }
              END { exit(found ? 0 : 1) }
            ' "$file"; then
              OBSERVE_CALL_OK=1
              break
            fi
          done

          if [ "$OBSERVE_CALL_OK" -ne 1 ]; then
            echo "❌ STUB DETECTED in toolObserveCommandResult"
            exit 1
          fi

          echo "✅ No stub implementations found"

      - name: Verify critical files unchanged
        if: github.event_name == 'pull_request'
        run: |
          # Get list of changed files (use .. for simple diff, not ... for merge-base)
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD 2>/dev/null || echo "")

          # Check if critical files were modified
          CRITICAL_FILES=(
            "internal/capture/queries.go"
            "internal/capture/handlers.go"
            "cmd/dev-console/tools_core.go"
            "cmd/dev-console/tools_observe.go"
            "cmd/dev-console/tools_interact.go"
          )

          for file in "${CRITICAL_FILES[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^$file$"; then
              echo "⚠️  WARNING: Critical file modified: $file"
              echo "This PR modifies async queue architecture."
              echo "Ensure you have ADR approval and all enforcement layers are updated."
              echo "See: docs/architecture/ADR-002-async-queue-immutability.md"
            fi
          done

      - name: Summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Architecture validation PASSED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "The async queue-and-poll architecture is intact."
          echo "All critical components are present and functional."

      - name: Failure guidance
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ Architecture validation FAILED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "The async queue-and-poll architecture is broken."
          echo "DO NOT merge this PR."
          echo ""
          echo "See: docs/architecture/ADR-002-async-queue-immutability.md"
          echo "Or ask: 'How do I restore the async queue implementation?'"
          exit 1
