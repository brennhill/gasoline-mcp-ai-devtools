name: CI

on:
  push:
    branches: [main, next]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: read

jobs:
  # Version consistency check - BLOCKING
  versions:
    name: Version Consistency
    uses: ./.github/workflows/validate-versions.yml

  upgrade-guards:
    name: Upgrade Guards (${{ matrix.os }})
    needs: versions
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.24"

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.12"

      - name: Go mismatch guard
        run: go test ./cmd/dev-console -run TestConnectWithRetriesRejectsVersionMismatch -count=1

      - name: Upgrade script contract tests
        run: node --test scripts/install-upgrade-regression.contract.test.mjs

      - name: npm cleanup tests
        run: node --test npm/gasoline-mcp/lib/kill-daemon.test.js

      - name: PyPI cleanup tests
        run: PYTHONPATH=pypi/gasoline-mcp python -m unittest discover -s pypi/gasoline-mcp/tests -p "test_*.py"

      - name: End-to-end upgrade regression
        run: node scripts/install-upgrade-regression.mjs

  go:
    name: Go Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.24"

      - name: Go vet
        run: go vet ./cmd/dev-console/

      - name: Validate Codex skill frontmatter
        run: ./scripts/validate-codex-skills.sh

      - name: Go tests with race detection
        run: go test -race -v ./cmd/dev-console/...

      - name: Reliability soak gate (bridge fast-start)
        run: |
          STATE_DIR="$(mktemp -d)"
          echo "Using state dir: ${STATE_DIR}"
          GASOLINE_STATE_DIR="${STATE_DIR}" go test -race ./cmd/dev-console -run TestFastStart_ResourceWorkflowSoak -count=3 -timeout=12m
          go run ./cmd/dev-console --check --state-dir "${STATE_DIR}" --fastpath-min-samples 100 --fastpath-max-failure-ratio 0.02

      - name: Go test coverage (70% minimum)
        run: |
          go test -coverprofile=coverage.out ./cmd/dev-console/...
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "FAIL: Coverage ${COVERAGE}% is below 70% threshold"
            exit 1
          fi
          echo "OK: Coverage ${COVERAGE}% meets 70% threshold"

      - name: Verify zero external dependencies
        run: |
          if grep -q '^require' go.mod; then
            echo "FAIL: go.mod contains external dependencies"
            exit 1
          fi
          if [ -f go.sum ]; then
            echo "FAIL: go.sum exists (implies external dependencies)"
            exit 1
          fi
          echo "OK: Zero external dependencies verified"

  javascript:
    name: JavaScript Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: ESLint (errors only)
        run: |
          npx eslint extension/ tests/extension/ --max-warnings=50 || {
            echo ""
            echo "WARNING: ESLint found issues (allowing up to 50 warnings)"
          }

      - name: TypeScript typecheck
        run: npx tsc --noEmit

      - name: Extension tests
        run: |
          node --test --test-force-exit --test-timeout=60000 --test-concurrency=4 --test-reporter=spec tests/extension/*.test.js

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.24"

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Go security scan (gosec)
        run: |
          gosec -exclude=G104,G114,G204,G301,G304,G306 -severity=high ./cmd/dev-console/

      - name: JS security lint
        run: |
          npx eslint extension/ tests/extension/ --max-warnings=50

      - name: Codacy Security Scan
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        env:
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: brennhill
          CODACY_PROJECT_NAME: gasoline-mcp-ai-devtools
        run: |
          if [ -z "$CODACY_API_TOKEN" ]; then
            echo "WARNING: Codacy API token not configured (skipping scan)"
            exit 0
          fi
          # Install Codacy client if needed and run scan
          echo "Codacy scan configured (will run when token is set)"
