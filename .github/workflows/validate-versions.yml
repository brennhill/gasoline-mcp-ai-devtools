name: Validate Versions

on:
  push:
    branches: [main, next]
  pull_request:
    branches: [main, next]
  workflow_call: # Allow other workflows to call this

jobs:
  validate-versions:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Validate all versions match VERSION file
        run: |
          VERSION=$(cat VERSION)
          echo "Expected version: $VERSION"
          echo ""

          ERRORS=0

          # Critical files that MUST match VERSION
          declare -A CRITICAL_FILES=(
            ["cmd/dev-console/main.go"]="version = \"$VERSION\""
            ["npm/gasoline-mcp/package.json"]="\"version\": \"$VERSION\""
            ["npm/darwin-arm64/package.json"]="\"version\": \"$VERSION\""
            ["npm/darwin-x64/package.json"]="\"version\": \"$VERSION\""
            ["npm/linux-arm64/package.json"]="\"version\": \"$VERSION\""
            ["npm/linux-x64/package.json"]="\"version\": \"$VERSION\""
            ["npm/win32-x64/package.json"]="\"version\": \"$VERSION\""
            ["extension/manifest.json"]="\"version\": \"$VERSION\""
            ["extension/package.json"]="\"version\": \"$VERSION\""
            ["pypi/gasoline-mcp/pyproject.toml"]="version = \"$VERSION\""
            ["pypi/gasoline-mcp-darwin-arm64/pyproject.toml"]="version = \"$VERSION\""
            ["pypi/gasoline-mcp-darwin-x64/pyproject.toml"]="version = \"$VERSION\""
            ["pypi/gasoline-mcp-linux-arm64/pyproject.toml"]="version = \"$VERSION\""
            ["pypi/gasoline-mcp-linux-x64/pyproject.toml"]="version = \"$VERSION\""
            ["pypi/gasoline-mcp-win32-x64/pyproject.toml"]="version = \"$VERSION\""
            ["server/package.json"]="\"version\": \"$VERSION\""
          )

          for file in "${!CRITICAL_FILES[@]}"; do
            pattern="${CRITICAL_FILES[$file]}"
            if [ -f "$file" ]; then
              if grep -q "$pattern" "$file"; then
                echo "✓ $file"
              else
                echo "✗ $file - expected pattern: $pattern"
                ERRORS=$((ERRORS + 1))
              fi
            else
              echo "? $file - file not found"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo ""

          # Check optionalDependencies in main package.json
          echo "Checking optionalDependencies in npm/gasoline-mcp/package.json..."
          OPTIONAL_DEPS=$(node -e "
            const pkg = require('./npm/gasoline-mcp/package.json');
            const deps = pkg.optionalDependencies || {};
            let errors = 0;
            for (const [name, version] of Object.entries(deps)) {
              if (version !== '$VERSION') {
                console.log('✗ ' + name + ': ' + version + ' (expected $VERSION)');
                errors++;
              } else {
                console.log('✓ ' + name + ': ' + version);
              }
            }
            process.exit(errors);
          ")

          if [ $? -ne 0 ]; then
            ERRORS=$((ERRORS + 1))
          fi

          echo ""

          if [ $ERRORS -gt 0 ]; then
            echo "❌ FAILED: $ERRORS version mismatches found"
            echo ""
            echo "To fix, run: node scripts/bump-version.js $VERSION"
            exit 1
          else
            echo "✅ All versions are consistent: $VERSION"
          fi

      - name: Verify Go binary version matches
        run: |
          VERSION=$(cat VERSION)

          # Check the version constant in main.go
          GO_VERSION=$(grep -o 'version = "[^"]*"' cmd/dev-console/main.go | head -1 | cut -d'"' -f2)

          if [ "$GO_VERSION" != "$VERSION" ]; then
            echo "❌ Go binary version mismatch: $GO_VERSION (expected $VERSION)"
            exit 1
          fi

          echo "✅ Go binary version: $GO_VERSION"
