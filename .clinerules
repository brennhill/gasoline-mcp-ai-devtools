# Cline Custom Instructions for Gasoline Project

**Browser extension + MCP server for real-time browser telemetry**
Stack: Go (zero deps) | Chrome Extension (MV3) | MCP (JSON-RPC 2.0) | NPM distribution

---

## ğŸš€ START HERE (Every Session)

**Before starting any task, always:**
1. Read CLAUDE.md for project overview and navigation
2. Check task requirements against the 8 core rules below
3. Load relevant documentation on-demand using the quick reference

---

## âš¡ THE 8 CORE RULES (Never Violate These)

1. **Spec Review** â€” All feature specs need principal review before implementation
2. **TDD** â€” Write tests FIRST, then code (always)
3. **TypeScript** â€” No `any` types, strict mode, run `make compile-ts` after src/ changes
4. **Zero Deps** â€” No production runtime dependencies
5. **5 Tools Max** â€” Gasoline has exactly 5 MCP tools: observe, generate, configure, interact, analyze (no 6th tool)
6. **Performance** â€” WebSocket < 0.1ms, HTTP fetch < 0.5ms, no main thread blocks
7. **Privacy** â€” Sensitive data stays on localhost
8. **Docs** â€” Update documentation BEFORE committing (mandatory)

---

## ğŸ¯ FEATURE WORKFLOW (5 Gates - DO NOT SKIP)

All features, bugs, and infrastructure changes MUST follow:

```
1. product-spec.md    â†’ Define what users need
   â†“
2. tech-spec.md       â†’ Define how to build it
   â†“
3. Principal Review   â†’ Get approval from senior engineer
   â†“
4. qa-plan.md         â†’ Write tests BEFORE implementation
   â†“
5. Implementation     â†’ Write code AFTER tests pass
```

**If tempted to skip a gate, STOP and re-read this workflow.**

---

## âœ… BEFORE EVERY COMMIT

```
â˜ Tests pass: make test (Go + extension tests)
â˜ Linting passes: npm run lint
â˜ TypeScript strict: npm run typecheck
â˜ File size < 800 LOC (refactor if larger)
â˜ Documentation updated (TECH_SPEC, QA_PLAN, etc.)
â˜ YAML frontmatter updated (last-verified = today's date)
â˜ Lint docs: python3 scripts/lint-documentation.py (no errors)
â˜ No broken links in documentation
â˜ Ready for code review
```

---

## ğŸ› ï¸ ESSENTIAL COMMANDS

```bash
# Development
npm run typecheck          # TypeScript check (no emit)
npm run lint              # ESLint check
npm run format:fix        # Prettier fix
make test                 # Go + extension tests
make ci-local             # Full CI (lint + format + typecheck + tests)
make compile-ts           # Compile TypeScript (REQUIRED after src/ changes)

# Documentation
python3 scripts/lint-documentation.py           # Check for doc errors
python3 scripts/generate-feature-navigation.py  # Regenerate feature index

# Git
git status                # Check what changed
git add -A                # Stage changes
git commit -m "..."       # Commit with message
git push                  # Push to remote
```

---

## ğŸ“š FIND INFORMATION FAST

| Question | File |
|----------|------|
| What rules apply? | CLAUDE.md |
| How do I do X? | docs/how-to-use-new-system.md |
| Where is feature Y? | docs/features/feature-navigation.md |
| Related docs? | docs/cross-reference.md |
| System design? | .claude/refs/architecture.md |
| Testing help? | .claude/docs/testing.md |
| Git workflow? | .claude/docs/git-and-concurrency.md |
| Bug details? | docs/core/known-issues.md |
| Implementation details? | docs/features/feature/[name]/tech-spec.md |

---

## ğŸ’» CODING STANDARDS

### TypeScript/JavaScript Rules
- **No `any` types** - Use specific types with TypeScript strict mode
- **File size limits**: Target < 500 LOC, Acceptable < 650 LOC, Maximum < 800 LOC (refactor if larger)
- **Discriminated unions** for message types
- **Branded types** for IDs (TabId, QueryId, SessionId)
- **Type guards** for runtime validation
- **Export `resetForTesting()`** from all stateful modules
- **No var** - Use const/let only

### Extension Development
- Validate message sender (no untrusted sources)
- Use `chrome.storage.session` (ephemeral) vs `.local` (persistent)
- Handle service worker restart gracefully
- Never trust page JavaScript - content script mediates
- All code must be bundled locally (Chrome Web Store requirement)

### Testing
- **Write tests BEFORE code** (TDD)
- All tests must pass: `node --test tests/extension/*.test.js`
- Zero regressions allowed

---

## ğŸ“„ DOCUMENTATION REQUIREMENTS (MANDATORY)

All documentation files MUST have this YAML frontmatter:

```yaml
status: [proposed|in-progress|shipped|deprecated]
scope: feature/<name>
ai-priority: [high|medium|low]
tags: [tag1, tag2]
relates-to: [related-doc.md]
last-verified: YYYY-MM-DD  # TODAY'S DATE when you edit!
```

**Documentation maintenance workflow:**
1. Update all affected docs when making changes
2. Add/update YAML frontmatter (set `last-verified` to today)
3. Run `python3 scripts/lint-documentation.py` - must pass with no errors
4. Check for broken links
5. Commit code + docs together

---

## ğŸ” DEBUGGING CHECKLIST

```
âŒ Types don't match?        â†’ npm run typecheck
âŒ Tests failing?             â†’ make test
âŒ Linting errors?            â†’ npm run lint
âŒ Broken docs?               â†’ python3 scripts/lint-documentation.py
âŒ Code doesn't run?          â†’ make compile-ts
âŒ Performance slow?          â†’ Check WS/fetch in DevTools
âŒ CI failing?                â†’ Run make ci-local locally first
```

---

## ğŸŒªï¸ "I'M STUCK" FLOW

1. **Check KNOWN-ISSUES.md** â€” Is it already documented?
2. **Search codebase** â€” Did someone solve this before?
3. **Check lint/test output** â€” What's the actual error?
4. **Read tech-spec.md** â€” Is this expected behavior?
5. **Ask principal engineer** â€” If still unclear

---

## ğŸ“‚ DOCUMENTATION STRUCTURE (Key Locations)

```
docs/
â”œâ”€â”€ README.md                          (master index)
â”œâ”€â”€ how-to-use-new-system.md          (start here for navigation)
â”œâ”€â”€ cross-reference.md                (find docs by relationship)
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ feature-navigation.md          (all 71+ features indexed)
â”‚   â”œâ”€â”€ README.md                      (LLM-optimized guide)
â”‚   â””â”€â”€ feature/<name>/
â”‚       â”œâ”€â”€ product-spec.md            (requirements)
â”‚       â”œâ”€â”€ tech-spec.md               (implementation)
â”‚       â””â”€â”€ qa-plan.md                 (tests)
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ codebase-canon-v5.3.md        (v5.3 baseline)
â”‚   â”œâ”€â”€ release.md                    (release process)
â”‚   â””â”€â”€ known-issues.md               (blockers)
â””â”€â”€ adrs/
    â””â”€â”€ ADR-<name>.md                 (architecture decisions)

.claude/
â”œâ”€â”€ instructions.md                    (development workflow)
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ startup-checklist.md          (read first every session)
â”‚   â”œâ”€â”€ quick-reference.md            (one-page cheat sheet)
â”‚   â”œâ”€â”€ feature-workflow.md           (5-gate process)
â”‚   â”œâ”€â”€ testing.md                    (TDD workflow)
â”‚   â”œâ”€â”€ spec-review.md                (review process)
â”‚   â”œâ”€â”€ documentation-maintenance.md  (doc update workflow)
â”‚   â””â”€â”€ git-and-concurrency.md       (git workflow)
â””â”€â”€ refs/
    â”œâ”€â”€ architecture.md               (system design)
    â”œâ”€â”€ extension-architecture.md    (16K comprehensive guide)
    â”œâ”€â”€ api-naming-detailed.md        (API conventions)
    â””â”€â”€ testing-examples.md           (test patterns)
```

---

## ğŸ¯ TASK-SPECIFIC GUIDANCE

### Implementing a Feature
1. Read `docs/features/README.md` for feature folder structure
2. Follow the 5-gate workflow (never skip)
3. Get principal review before implementation
4. Write tests first (TDD)
5. Update all affected documentation

### Fixing a Bug
1. Find issue in `docs/core/known-issues.md`
2. Read product-spec.md (expected behavior)
3. Read tech-spec.md (current implementation)
4. Write test that reproduces bug
5. Fix bug to make test pass
6. Update qa-plan.md with regression test
7. Mark fixed in known-issues.md
8. Update documentation

### Understanding the System
- Start with `.claude/refs/architecture.md`
- Check `docs/cross-reference.md` for related docs
- Use `docs/features/feature-navigation.md` to find features

---

## ğŸ’¡ CONTEXT LOADING STRATEGY

**At session start:** Load CLAUDE.md + this file (~5K tokens)

**For a task:** Load feature specs + relevant architecture docs (~20-25K tokens)

**Between tasks:** Swap context (don't accumulate - reload only what's needed)

**See:** `.claude/docs/context-on-demand.md` for detailed strategy

---

## âš ï¸ CRITICAL INCIDENTS TO AVOID

**Jan 30, 2026 - Test Boundaries Violation:**
- Implementation completed before tests written
- Workflow violated
- **Resolution:** Created feature-workflow.md to prevent recurrence
- **Lesson:** NEVER skip the 5-gate process

---

**Last Updated:** 2026-01-31  
**For:** Cline AI Assistant  
**Purpose:** Complete guidance for Gasoline project development