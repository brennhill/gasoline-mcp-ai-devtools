#!/usr/bin/env node

const { execFileSync } = require('child_process');
const path = require('path');
const fs = require('fs');
const os = require('os');

function getPlatformPackage() {
  const platform = os.platform();
  const arch = os.arch();

  const platformMap = {
    'darwin-arm64': '@brennhill/gasoline-darwin-arm64',
    'darwin-x64': '@brennhill/gasoline-darwin-x64',
    'linux-arm64': '@brennhill/gasoline-linux-arm64',
    'linux-x64': '@brennhill/gasoline-linux-x64',
    'win32-x64': '@brennhill/gasoline-win32-x64',
  };

  const key = `${platform}-${arch}`;
  const pkg = platformMap[key];

  if (!pkg) {
    console.error(`Unsupported platform: ${platform}-${arch}`);
    console.error(`Supported platforms: ${Object.keys(platformMap).join(', ')}`);
    process.exit(1);
  }

  return pkg;
}

function findBinary() {
  const pkg = getPlatformPackage();
  const binaryName = os.platform() === 'win32' ? 'gasoline.exe' : 'gasoline';

  // Try to resolve from node_modules
  const candidates = [
    // Installed as dependency
    path.join(__dirname, '..', 'node_modules', pkg, 'bin', binaryName),
    // Hoisted in monorepo
    path.join(__dirname, '..', '..', pkg, 'bin', binaryName),
    // npm global install
    path.join(__dirname, '..', '..', '..', pkg, 'bin', binaryName),
  ];

  for (const candidate of candidates) {
    if (fs.existsSync(candidate)) {
      return candidate;
    }
  }

  // Try require.resolve as fallback
  try {
    const pkgPath = require.resolve(`${pkg}/package.json`);
    const binPath = path.join(path.dirname(pkgPath), 'bin', binaryName);
    if (fs.existsSync(binPath)) {
      return binPath;
    }
  } catch (e) {
    // Package not found
  }

  console.error(`Could not find gasoline binary for your platform.`);
  console.error(`Expected package: ${pkg}`);
  console.error(`\nTry reinstalling: npm install -g gasoline-cli`);
  process.exit(1);
}

const binary = findBinary();

try {
  const result = execFileSync(binary, process.argv.slice(2), {
    stdio: 'inherit',
    env: process.env,
  });
} catch (e) {
  if (e.status !== null) {
    process.exit(e.status);
  }
  throw e;
}
