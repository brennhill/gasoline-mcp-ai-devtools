#!/usr/bin/env node

// bin/gasoline-mcp — Cross-platform launcher for the Gasoline MCP server.
// MCP mode (default): finds the Go binary and spawns it.
// CLI commands (--install, --config, etc.): delegates to lib/cli.js.

const { execFileSync } = require('child_process')
const path = require('path')
const fs = require('fs')

const GASOLINE_VERSION = require('../package.json').version
const SCRIPT_DIR = __dirname
const LIB_DIR = path.join(SCRIPT_DIR, '..', 'lib')

// --- Platform detection ---

function detectPlatform() {
  const platformMap = { darwin: 'darwin', linux: 'linux', win32: 'win32' }
  const archMap = { x64: 'x64', arm64: 'arm64' }

  const platform = platformMap[process.platform]
  const arch = archMap[process.arch]

  if (!platform || !arch) {
    return null
  }

  const ext = process.platform === 'win32' ? '.exe' : ''
  // Windows x64 binary runs on arm64 via emulation
  const effectiveArch = (platform === 'win32') ? 'x64' : arch
  const platformKey = `${platform}-${effectiveArch}`
  const binaryName = `gasoline${ext}`
  const pkgName = `@brennhill/gasoline-${platformKey}`

  return { platform, arch: effectiveArch, platformKey, binaryName, pkgName, ext }
}

// --- Binary search ---

function findBinary(info) {
  // 1. Dev build — dist/ directory (for local development)
  const devBin = path.join(SCRIPT_DIR, '..', '..', '..', 'dist', `gasoline-${info.platformKey}${info.ext}`)
  if (fs.existsSync(devBin)) return devBin

  // 2. node_modules candidates (3 depths: local dep, hoisted, global)
  const candidates = [
    path.join(SCRIPT_DIR, '..', 'node_modules', info.pkgName, 'bin', info.binaryName),
    path.join(SCRIPT_DIR, '..', '..', info.pkgName, 'bin', info.binaryName),
    path.join(SCRIPT_DIR, '..', '..', '..', info.pkgName, 'bin', info.binaryName),
  ]
  for (const candidate of candidates) {
    if (fs.existsSync(candidate)) return candidate
  }

  // 3. Global PATH — check version matches
  try {
    const { execSync } = require('child_process')
    const which = process.platform === 'win32' ? 'where gasoline' : 'command -v gasoline'
    const globalBin = execSync(which, { encoding: 'utf8', stdio: ['pipe', 'pipe', 'pipe'] }).trim().split('\n')[0]
    if (globalBin && fs.existsSync(globalBin)) {
      const verOut = execFileSync(globalBin, ['--version'], { encoding: 'utf8', timeout: 5000, stdio: ['pipe', 'pipe', 'pipe'] })
      const verMatch = verOut.match(/(\d+\.\d+\.\d+)/)
      if (verMatch && verMatch[1] === GASOLINE_VERSION) return globalBin
    }
  } catch {
    // Not found in PATH or version mismatch — continue
  }

  return null
}

// --- CLI flag detection ---

function isCliCommand(args) {
  const cliFlags = new Set(['--config', '-c', '--install', '-i', '--doctor', '--uninstall', '--help', '-h', '--version', '-v'])
  return args.some(arg => cliFlags.has(arg))
}

// --- JSON-RPC error (so MCP clients see a protocol error, not a vanished process) ---

function mcpError(message) {
  const err = { jsonrpc: '2.0', id: null, error: { code: -32603, message, data: { isError: true } } }
  process.stdout.write(JSON.stringify(err) + '\n')
}

// --- Main ---

const info = detectPlatform()
if (!info) {
  mcpError(`Unsupported platform: ${process.platform}-${process.arch}`)
  process.exit(1)
}

const args = process.argv.slice(2)

// CLI commands → delegate to Node.js
if (isCliCommand(args)) {
  require(path.join(LIB_DIR, 'cli.js'))
  // cli.js handles process.argv directly
} else {
  // MCP server mode — find and exec the Go binary
  const binary = findBinary(info)
  if (!binary) {
    const msg = `Gasoline binary not found for ${info.platformKey}. Expected package: ${info.pkgName}. Try reinstalling: npm install -g gasoline-mcp@latest`
    mcpError(msg)
    process.exit(1)
  }

  try {
    execFileSync(binary, args, { stdio: 'inherit', windowsHide: false })
  } catch (e) {
    process.exit(e.status ?? 1)
  }
}
