{
  "version": 3,
  "sources": ["../src/early-patch.ts"],
  "sourcesContent": ["// early-patch.ts \u2014 Lightweight WebSocket + attachShadow patches.\n// Runs in MAIN world at document_start before any page scripts.\n// Saves original WebSocket and buffers connections for handoff to inject.bundled.js.\n// Captures closed shadow roots in a WeakMap for dom-primitives deep traversal.\n// Must be self-contained: no imports, no chrome.* APIs (MAIN world).\n\n;(function () {\n  'use strict'\n\n  if (typeof window === 'undefined') return\n\n  // Buffer early-patch diagnostics until inject script can forward them.\n  const MAX_EARLY_LOGS = 50\n  function emitEarlyLog(\n    level: 'debug' | 'info' | 'warn' | 'error',\n    message: string,\n    category: string,\n    data?: unknown\n  ): void {\n    const entry: EarlyPatchLogEntry = {\n      ts: new Date().toISOString(),\n      level,\n      message,\n      source: 'early-patch',\n      category,\n      ...(data !== undefined ? { data } : {})\n    }\n\n    if (window.__GASOLINE_INJECT_READY__) {\n      // inject.js is active; emit directly into the standard log path.\n      try {\n        window.postMessage(\n          {\n            type: 'GASOLINE_LOG',\n            payload: {\n              ts: entry.ts,\n              level: entry.level,\n              message: entry.message,\n              source: entry.source,\n              category: entry.category,\n              type: 'early_patch',\n              ...(entry.data !== undefined ? { data: entry.data } : {})\n            }\n          },\n          window.location.origin\n        )\n        return\n      } catch {\n        // Fall through to queue when postMessage fails.\n      }\n    }\n\n    const queue = window.__GASOLINE_EARLY_LOGS__ || []\n    queue.push(entry)\n    if (queue.length > MAX_EARLY_LOGS) {\n      queue.splice(0, queue.length - MAX_EARLY_LOGS)\n    }\n    window.__GASOLINE_EARLY_LOGS__ = queue\n  }\n\n  // --- Closed Shadow Root Capture ---\n  const OriginalAttachShadow = Element.prototype.attachShadow\n  if (OriginalAttachShadow && !window.__GASOLINE_CLOSED_SHADOWS__) {\n    const closedRoots = new WeakMap<Element, ShadowRoot>()\n    window.__GASOLINE_CLOSED_SHADOWS__ = closedRoots\n    window.__GASOLINE_ORIGINAL_ATTACH_SHADOW__ = OriginalAttachShadow\n    let overwriteCount = 0\n    let delegate: typeof Element.prototype.attachShadow = OriginalAttachShadow\n\n    // Always route attachShadow through this trampoline so closed-root capture survives page-level overrides.\n    const trampoline: typeof Element.prototype.attachShadow = function (\n      this: Element,\n      init: ShadowRootInit\n    ): ShadowRoot {\n      const root = delegate.call(this, init)\n      if (init.mode === 'closed') {\n        closedRoots.set(this, root)\n      }\n      return root\n    }\n\n    const originalDescriptor = Object.getOwnPropertyDescriptor(Element.prototype, 'attachShadow')\n    try {\n      Object.defineProperty(Element.prototype, 'attachShadow', {\n        configurable: true,\n        enumerable: originalDescriptor?.enumerable ?? false,\n        get(): typeof Element.prototype.attachShadow {\n          return trampoline\n        },\n        set(next: unknown): void {\n          if (typeof next !== 'function') {\n            emitEarlyLog('warn', 'attachShadow overwrite ignored (non-function)', 'shadow_dom', {\n              assigned_type: typeof next\n            })\n            return\n          }\n          if (next === trampoline) return\n\n          const replacement = next as typeof Element.prototype.attachShadow\n          delegate = function (this: Element, init: ShadowRootInit): ShadowRoot {\n            return replacement.call(this, init)\n          }\n\n          overwriteCount += 1\n          const marker = (replacement as { __gasolineMarker?: string }).__gasolineMarker\n          emitEarlyLog('warn', 'attachShadow overwrite intercepted', 'shadow_dom', {\n            overwrite_count: overwriteCount,\n            replacement_name: replacement.name || 'anonymous',\n            ...(marker ? { marker } : {})\n          })\n        }\n      })\n    } catch (error) {\n      // Fallback to direct patch if descriptor hardening fails.\n      emitEarlyLog('error', 'attachShadow hardening install failed; using fallback wrapper', 'shadow_dom', {\n        error: error instanceof Error ? error.message : String(error)\n      })\n      Element.prototype.attachShadow = trampoline\n    }\n  }\n\n  if (!window.WebSocket) return\n\n  // Guard: only install once (extension reloads, multiple frames)\n  if (window.__GASOLINE_ORIGINAL_WS__) return\n\n  const OriginalWS = window.WebSocket\n\n  // Store original for inject script to retrieve\n  window.__GASOLINE_ORIGINAL_WS__ = OriginalWS\n\n  // Buffer for early connections\n  const earlyConnections: EarlyWsConnection[] = []\n  window.__GASOLINE_EARLY_WS__ = earlyConnections\n\n  // Thin wrapper: creates real WebSocket + buffers lifecycle events\n  function EarlyWebSocket(this: unknown, url: string | URL, protocols?: string | string[]): WebSocket {\n    const ws = protocols !== undefined ? new OriginalWS(url, protocols) : new OriginalWS(url)\n    const conn: EarlyWsConnection = { ws, url: url.toString(), createdAt: Date.now(), events: [] }\n\n    ws.addEventListener('open', () => {\n      conn.events.push({ type: 'open', ts: Date.now() })\n    })\n    ws.addEventListener('close', (e: CloseEvent) => {\n      conn.events.push({ type: 'close', ts: Date.now(), code: e.code, reason: e.reason })\n    })\n    ws.addEventListener('error', () => {\n      conn.events.push({ type: 'error', ts: Date.now() })\n    })\n\n    earlyConnections.push(conn)\n\n    // Cap buffer to bound memory\n    if (earlyConnections.length > 50) {\n      earlyConnections.shift()\n    }\n\n    return ws\n  }\n\n  // Preserve prototype chain: instanceof WebSocket still works\n  EarlyWebSocket.prototype = OriginalWS.prototype\n\n  // Preserve static constants\n  Object.defineProperty(EarlyWebSocket, 'CONNECTING', { value: 0, writable: false })\n  Object.defineProperty(EarlyWebSocket, 'OPEN', { value: 1, writable: false })\n  Object.defineProperty(EarlyWebSocket, 'CLOSING', { value: 2, writable: false })\n  Object.defineProperty(EarlyWebSocket, 'CLOSED', { value: 3, writable: false })\n\n  window.WebSocket = EarlyWebSocket as unknown as typeof WebSocket\n})()\n"],
  "mappings": "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",
  "names": ["MAX_EARLY_LOGS", "emitEarlyLog", "level", "message", "category", "data", "entry", "queue", "OriginalAttachShadow", "closedRoots", "overwriteCount", "delegate", "trampoline", "init", "root", "originalDescriptor", "next", "replacement", "marker", "error", "OriginalWS", "earlyConnections", "EarlyWebSocket", "url", "protocols", "ws", "conn", "e"]
}
