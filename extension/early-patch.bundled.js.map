{
  "version": 3,
  "sources": ["../src/early-patch.ts"],
  "sourcesContent": ["// early-patch.ts \u2014 Lightweight WebSocket + attachShadow patches.\n// Runs in MAIN world at document_start before any page scripts.\n// Saves original WebSocket and buffers connections for handoff to inject.bundled.js.\n// Captures closed shadow roots in a WeakMap for dom-primitives deep traversal.\n// Must be self-contained: no imports, no chrome.* APIs (MAIN world).\n\n;(function () {\n  'use strict'\n\n  if (typeof window === 'undefined') return\n\n  // --- Closed Shadow Root Capture ---\n  const OriginalAttachShadow = Element.prototype.attachShadow\n  if (OriginalAttachShadow && !window.__GASOLINE_CLOSED_SHADOWS__) {\n    const closedRoots = new WeakMap<Element, ShadowRoot>()\n    window.__GASOLINE_CLOSED_SHADOWS__ = closedRoots\n    window.__GASOLINE_ORIGINAL_ATTACH_SHADOW__ = OriginalAttachShadow\n\n    Element.prototype.attachShadow = function (\n      this: Element,\n      init: ShadowRootInit\n    ): ShadowRoot {\n      const root = OriginalAttachShadow.call(this, init)\n      if (init.mode === 'closed') {\n        closedRoots.set(this, root)\n      }\n      return root\n    }\n  }\n\n  if (!window.WebSocket) return\n\n  // Guard: only install once (extension reloads, multiple frames)\n  if (window.__GASOLINE_ORIGINAL_WS__) return\n\n  const OriginalWS = window.WebSocket\n\n  // Store original for inject script to retrieve\n  window.__GASOLINE_ORIGINAL_WS__ = OriginalWS\n\n  // Buffer for early connections\n  const earlyConnections: EarlyWsConnection[] = []\n  window.__GASOLINE_EARLY_WS__ = earlyConnections\n\n  // Thin wrapper: creates real WebSocket + buffers lifecycle events\n  function EarlyWebSocket(this: unknown, url: string | URL, protocols?: string | string[]): WebSocket {\n    const ws = protocols !== undefined ? new OriginalWS(url, protocols) : new OriginalWS(url)\n    const conn: EarlyWsConnection = { ws, url: url.toString(), createdAt: Date.now(), events: [] }\n\n    ws.addEventListener('open', () => {\n      conn.events.push({ type: 'open', ts: Date.now() })\n    })\n    ws.addEventListener('close', (e: CloseEvent) => {\n      conn.events.push({ type: 'close', ts: Date.now(), code: e.code, reason: e.reason })\n    })\n    ws.addEventListener('error', () => {\n      conn.events.push({ type: 'error', ts: Date.now() })\n    })\n\n    earlyConnections.push(conn)\n\n    // Cap buffer to bound memory\n    if (earlyConnections.length > 50) {\n      earlyConnections.shift()\n    }\n\n    return ws\n  }\n\n  // Preserve prototype chain: instanceof WebSocket still works\n  EarlyWebSocket.prototype = OriginalWS.prototype\n\n  // Preserve static constants\n  Object.defineProperty(EarlyWebSocket, 'CONNECTING', { value: 0, writable: false })\n  Object.defineProperty(EarlyWebSocket, 'OPEN', { value: 1, writable: false })\n  Object.defineProperty(EarlyWebSocket, 'CLOSING', { value: 2, writable: false })\n  Object.defineProperty(EarlyWebSocket, 'CLOSED', { value: 3, writable: false })\n\n  window.WebSocket = EarlyWebSocket as unknown as typeof WebSocket\n})()\n"],
  "mappings": "oBAME,UAAA,CACA,aAEA,GAAI,OAAO,OAAW,IAAa,OAGnC,IAAMA,EAAuB,QAAQ,UAAU,aAC/C,GAAIA,GAAwB,CAAC,OAAO,4BAA6B,CAC/D,IAAMC,EAAc,IAAI,QACxB,OAAO,4BAA8BA,EACrC,OAAO,oCAAsCD,EAE7C,QAAQ,UAAU,aAAe,SAE/BE,EAAoB,CAEpB,IAAMC,EAAOH,EAAqB,KAAK,KAAME,CAAI,EACjD,OAAIA,EAAK,OAAS,UAChBD,EAAY,IAAI,KAAME,CAAI,EAErBA,CACT,CACF,CAKA,GAHI,CAAC,OAAO,WAGR,OAAO,yBAA0B,OAErC,IAAMC,EAAa,OAAO,UAG1B,OAAO,yBAA2BA,EAGlC,IAAMC,EAAwC,CAAA,EAC9C,OAAO,sBAAwBA,EAG/B,SAASC,EAA8BC,EAAmBC,EAA6B,CACrF,IAAMC,EAAKD,IAAc,OAAY,IAAIJ,EAAWG,EAAKC,CAAS,EAAI,IAAIJ,EAAWG,CAAG,EAClFG,EAA0B,CAAE,GAAAD,EAAI,IAAKF,EAAI,SAAQ,EAAI,UAAW,KAAK,IAAG,EAAI,OAAQ,CAAA,CAAE,EAE5F,OAAAE,EAAG,iBAAiB,OAAQ,IAAK,CAC/BC,EAAK,OAAO,KAAK,CAAE,KAAM,OAAQ,GAAI,KAAK,IAAG,CAAE,CAAE,CACnD,CAAC,EACDD,EAAG,iBAAiB,QAAUE,GAAiB,CAC7CD,EAAK,OAAO,KAAK,CAAE,KAAM,QAAS,GAAI,KAAK,IAAG,EAAI,KAAMC,EAAE,KAAM,OAAQA,EAAE,MAAM,CAAE,CACpF,CAAC,EACDF,EAAG,iBAAiB,QAAS,IAAK,CAChCC,EAAK,OAAO,KAAK,CAAE,KAAM,QAAS,GAAI,KAAK,IAAG,CAAE,CAAE,CACpD,CAAC,EAEDL,EAAiB,KAAKK,CAAI,EAGtBL,EAAiB,OAAS,IAC5BA,EAAiB,MAAK,EAGjBI,CACT,CAGAH,EAAe,UAAYF,EAAW,UAGtC,OAAO,eAAeE,EAAgB,aAAc,CAAE,MAAO,EAAG,SAAU,EAAK,CAAE,EACjF,OAAO,eAAeA,EAAgB,OAAQ,CAAE,MAAO,EAAG,SAAU,EAAK,CAAE,EAC3E,OAAO,eAAeA,EAAgB,UAAW,CAAE,MAAO,EAAG,SAAU,EAAK,CAAE,EAC9E,OAAO,eAAeA,EAAgB,SAAU,CAAE,MAAO,EAAG,SAAU,EAAK,CAAE,EAE7E,OAAO,UAAYA,CACrB,GAAE",
  "names": ["OriginalAttachShadow", "closedRoots", "init", "root", "OriginalWS", "earlyConnections", "EarlyWebSocket", "url", "protocols", "ws", "conn", "e"]
}
