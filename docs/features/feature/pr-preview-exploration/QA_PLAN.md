# QA Plan: PR Preview Exploration

> QA plan for the PR Preview Exploration feature. Covers data leak analysis, LLM clarity, simplicity assessment, code-level testing, and step-by-step UAT verification.

---

## 1. Data Leak Analysis

**Goal:** Verify the feature does NOT expose data it shouldn't. PR Preview Exploration navigates to external preview environments, captures runtime telemetry, compares against baselines, and produces reports posted as PR comments. The feature interacts with external URLs (preview deployments), uses `execute_js` for browser control, and generates public-facing reports. Each of these surfaces has distinct data leak risks.

| # | Data Leak Risk | What to Check | Severity |
|---|---------------|---------------|----------|
| DL-1 | Auth tokens in preview URL exposed in MCP responses | Verify that when the preview URL contains authentication tokens (e.g., `?token=abc123`), the token is redacted in all MCP tool responses, reports, and telemetry | critical |
| DL-2 | Cookie injection script captured in log buffer | Verify that when the agent injects auth cookies via `execute_js("document.cookie = 'session=abc123'")`, the cookie value is NOT captured in the console log buffer (the script string is captured, but the spec says side effects are not) | critical |
| DL-3 | PR comment report exposes internal error messages | Verify that the PR summary report generated by `generate({format: "pr_summary"})` does not include internal server error details, database connection strings, or stack traces from the preview environment | high |
| DL-4 | Preview environment test data appears in telemetry | Verify that personally identifiable information (PII) from the preview environment (user names, emails, addresses in test data) is handled by existing redaction rules and does not appear unredacted in reports | high |
| DL-5 | SARIF output contains internal infrastructure paths | Verify that `generate({format: "sarif"})` does not expose internal file paths, server infrastructure details, or internal API endpoint structures from the preview environment | high |
| DL-6 | Baseline snapshot contains production credentials | Verify that when the agent captures a live baseline from the production/main-branch site, no production credentials, session tokens, or API keys are captured in the snapshot | critical |
| DL-7 | Network body capture from preview environment | Verify that network response bodies from the preview environment (which may contain test data, internal API responses) follow the opt-in body capture rule and apply redaction patterns | high |
| DL-8 | execute_js reads sensitive page data | Verify that the agent's `execute_js` scripts for exploration (clicking, typing, scrolling) do NOT read sensitive page data (localStorage, sessionStorage, form values with credentials) and return it in MCP responses | critical |
| DL-9 | Preview URL convention template exposes infrastructure | Verify that the stored preview URL template (e.g., `preview-{pr_number}.myapp.dev`) does not expose internal infrastructure naming conventions that should not be public | medium |
| DL-10 | Cross-origin data leakage during exploration | Verify that the agent's browser tab isolation prevents telemetry from the developer's other tabs from leaking into the preview exploration session | high |
| DL-11 | Session diff reveals sensitive data from both environments | Verify that `diff_sessions` comparing baseline (production) and preview does not expose combined sensitive data from both environments in a single response | high |
| DL-12 | Exploration report posted as PR comment exposes secrets | Verify that the final PR comment generated by the agent does not include auth tokens, internal URLs, PII, or credentials from the preview exploration | critical |

### Negative Tests (must NOT leak)
- [ ] Preview URL auth tokens (e.g., `?token=abc123`) must be redacted in all MCP responses
- [ ] Auth cookies set via `execute_js` must not appear in console log captures
- [ ] Production baseline snapshots must not contain session cookies or auth tokens
- [ ] PR comment reports must not include internal server error stack traces
- [ ] SARIF output must not contain absolute server-side file paths
- [ ] `execute_js` scripts must not return localStorage/sessionStorage contents
- [ ] Network body content from preview must follow opt-in rules and apply redaction
- [ ] Cross-tab telemetry isolation must prevent developer tab data from appearing in exploration results
- [ ] Preview URL convention templates must not be exposed in PR comments or reports

---

## 2. LLM Clarity Assessment

**Goal:** Verify an AI agent reading the tool responses can unambiguously understand the data without misinterpretation.

| # | Clarity Check | What to Verify | Status |
|---|--------------|----------------|--------|
| CL-1 | Phase progression clarity | Verify the AI can determine which phase it is in (Discover, Baseline, Explore, Compare, Report) from the tool responses without ambiguity | [ ] |
| CL-2 | Preview URL discovery fallback chain | Verify the AI understands the priority order: (1) human-provided URL, (2) stored convention template, (3) GitHub API, (4) ask human -- and knows when to fall through | [ ] |
| CL-3 | Baseline strategy selection | Verify the AI can decide between live baseline (more accurate) and stored baseline (faster) based on available information (staleness threshold, production URL access) | [ ] |
| CL-4 | Exploration bounds as stop signals | Verify the AI understands that hitting any bound (max pages, max actions, timeout) means "stop exploring, proceed to compare" not "error occurred" | [ ] |
| CL-5 | Regression vs absolute finding | Verify the AI clearly distinguishes between regression findings (worse than baseline) and absolute findings (issues found, no baseline comparison) | [ ] |
| CL-6 | Session diff interpretation | Verify that `diff_sessions` compare output clearly shows what is new in the preview vs baseline, and the AI knows "new errors" means errors not in baseline, not "errors that just appeared" | [ ] |
| CL-7 | Preview not deployed vs preview broken | Verify the AI distinguishes between "preview URL returns connection refused" (not yet deployed) and "preview URL returns HTTP 500" (deployed but broken) | [ ] |
| CL-8 | Authentication required signal | Verify that when the preview redirects to a login page or returns 401/403, the AI recognizes this as "authentication needed" not "page broken" | [ ] |
| CL-9 | Partial exploration reporting | Verify that when exploration is bounded (stopped early), the report clearly states what was explored and what was NOT explored, so the reviewer knows coverage | [ ] |
| CL-10 | Baseline staleness warning | Verify that when a stored baseline is older than the threshold (default 24 hours), the warning is clear: "baseline is stale, comparison may be unreliable" not just "old baseline" | [ ] |
| CL-11 | Tab isolation confirmation | Verify the AI receives the `tab_id` from `interact({action: "new_tab"})` and understands subsequent interactions must target this tab, not the developer's tabs | [ ] |
| CL-12 | Empty exploration results | Verify that when no issues are found during exploration, the report clearly states "no regressions detected" (positive signal) rather than returning empty or null (ambiguous) | [ ] |

### Common LLM Misinterpretation Risks
- [ ] AI might navigate to the preview URL in the developer's current tab instead of opening a new tab -- verify new_tab action is used
- [ ] AI might interpret "preview not ready" as "preview exploration failed" -- verify the distinction is explicit in the retry/wait logic
- [ ] AI might skip baseline capture for speed and then have no comparison data -- verify baseline phase is flagged as required
- [ ] AI might interpret "no baseline available" as an error state instead of proceeding with absolute findings -- verify fallback behavior is clear
- [ ] AI might report buffer-evicted early findings as "not found" -- verify incremental processing is recommended
- [ ] AI might explore pages from the developer's site instead of the preview -- verify tab isolation and URL scoping
- [ ] AI might confuse "exploration timeout reached" with "page load timeout" -- verify these are distinct signals

---

## 3. Simplicity Assessment

**Goal:** Count steps and evaluate cognitive load for both human and AI users.

**Complexity Score:** High (orchestration pattern with many steps)

| Workflow | Steps Required | Can Be Simplified? |
|----------|---------------|-------------------|
| Phase 1: Discover preview URL (human provides) | 1 step: human pastes URL | No -- already minimal |
| Phase 1: Discover via convention | 2 steps: (1) load stored template, (2) substitute PR number | Yes -- could auto-detect PR number from git context |
| Phase 1: Discover via GitHub API | 2 steps: (1) query `gh api`, (2) extract environment_url | Yes -- but outside Gasoline's scope (external tool) |
| Phase 2: Baseline capture (live) | 3 steps: (1) navigate to production, (2) capture session snapshot, (3) save behavioral baseline | Yes -- could combine into single "capture baseline from URL" action |
| Phase 2: Baseline capture (stored) | 1 step: load saved baseline | No -- already minimal |
| Phase 3: Explore | 4+ steps: (1) open new tab, (2) wait for load, (3) interact with pages, (4) capture at end | No -- exploration is inherently multi-step; each page visit is a step |
| Phase 4: Compare | 2 steps: (1) session diff, (2) behavioral baseline compare | Yes -- could combine into single "compare preview against baseline" action |
| Phase 5: Report | 1-2 steps: (1) generate pr_summary, (2) optionally generate SARIF | No -- already minimal |
| Full workflow end-to-end | 12-15 steps minimum | Yes -- a Claude Code skill could encapsulate the entire workflow as `/explore-preview <url>` |

### Default Behavior Verification
- [ ] Agent uses `new_tab` by default for preview isolation (not overwriting developer's tab)
- [ ] Exploration bounds default to reasonable values (20 pages, 100 actions, 15 min timeout)
- [ ] Page load timeout defaults to 30 seconds per page
- [ ] Navigation depth defaults to 3 clicks deep
- [ ] Baseline staleness threshold defaults to 24 hours
- [ ] Agent processes telemetry incrementally per page (not waiting until end) to avoid buffer eviction
- [ ] Report includes both regression findings and absolute findings by default
- [ ] SARIF output is optional (not generated by default)
- [ ] AI Web Pilot toggle must be enabled before `execute_js` works (existing security gate)

---

## 4. Code Test Plan

### 4.1 Unit Tests

| # | Test Case | Input | Expected Output | Priority |
|---|-----------|-------|-----------------|----------|
| UT-1 | Navigate to preview via new_tab | `interact({action: "new_tab", url: "https://preview-42.myapp.dev"})` | New tab opened, tab_id returned | must |
| UT-2 | Session capture for baseline | `configure({action: "diff_sessions", session_action: "capture", name: "main-baseline"})` | Named snapshot saved in session manager | must |
| UT-3 | Session capture for preview | `configure({action: "diff_sessions", session_action: "capture", name: "preview-pr-42"})` | Named snapshot saved with preview telemetry | must |
| UT-4 | Session diff (baseline vs preview) | `configure({action: "diff_sessions", session_action: "compare", compare_a: "main-baseline", compare_b: "preview-pr-42"})` | Structured diff showing new errors, changed network responses, performance deltas | must |
| UT-5 | Error detection via observe | `observe({what: "errors"})` | Console errors from preview page returned | must |
| UT-6 | Performance capture via observe | `observe({what: "performance"})` | Web Vitals and load times from preview page | should |
| UT-7 | Accessibility audit via observe | `observe({what: "accessibility"})` | A11y violations detected on preview page | should |
| UT-8 | PR summary generation | `generate({format: "pr_summary"})` | Markdown report with errors, performance, and findings | must |
| UT-9 | SARIF generation | `generate({format: "sarif"})` | Valid SARIF JSON with findings | could |
| UT-10 | URL convention template retrieval | `configure({action: "store", store_action: "load", key: "preview_url_template"})` | Stored template returned (e.g., `https://preview-{pr_number}.myapp.dev`) | should |
| UT-11 | URL convention template substitution | Template `https://preview-{pr_number}.myapp.dev` with PR #42 | Resolved URL: `https://preview-42.myapp.dev` | should |
| UT-12 | Behavioral baseline comparison | `configure({action: "compare_baseline", name: "main-baseline"})` | Regression categories: network, timing, console, WebSocket | should |
| UT-13 | execute_js for page interaction | `interact({action: "execute_js", script: "document.querySelector('a[href=\"/dashboard\"]').click()"})` | Navigation triggered, page changes | must |
| UT-14 | Exploration bound: max pages | Agent visits 20 pages (at default max) | Exploration stops, agent proceeds to compare | must |
| UT-15 | Exploration bound: max actions | Agent performs 100 actions (at default max) | Exploration stops, agent proceeds to compare | must |
| UT-16 | Exploration bound: timeout | 15 minutes elapsed | Exploration stops, partial results captured | must |
| UT-17 | Preview returns 404 | Navigate to preview, page returns 404 | Agent reports "preview returns HTTP 404" and stops exploration | must |
| UT-18 | Preview returns 500 | Navigate to preview, page returns 500 | Agent reports "preview returns HTTP 500" and captures error telemetry | must |
| UT-19 | Preview requires authentication (401) | Navigate to preview, redirected to login page | Agent detects auth required, reports "authentication needed" | must |
| UT-20 | No baseline available | No stored or live baseline captured | Agent skips comparison, reports absolute findings only, notes "no baseline" | must |

### 4.2 Integration Tests

| # | Test Case | Components Involved | Expected Behavior | Priority |
|---|-----------|--------------------|--------------------|----------|
| IT-1 | Full 5-phase workflow | interact + observe + configure + generate | Agent discovers URL, captures baseline, explores preview, compares, generates report | must |
| IT-2 | Tab isolation during exploration | interact(new_tab) + observe + interact(execute_js) | All telemetry scoped to preview tab, developer tab unaffected | must |
| IT-3 | Incremental telemetry processing | observe(errors) after each page visit during exploration | Errors from early pages retained even if buffer approaches capacity | should |
| IT-4 | Baseline capture + comparison | configure(diff_sessions capture) + configure(diff_sessions compare) | Comparison accurately reflects differences between baseline and preview states | must |
| IT-5 | Behavioral baseline integration | configure(save_baseline) + configure(compare_baseline) | Behavioral regression categorization (network, timing, console, WebSocket) | should |
| IT-6 | PR summary includes exploration context | generate(pr_summary) after exploration | Report includes preview URL, pages visited, findings, regressions | must |
| IT-7 | Multiple concurrent explorations | Two agents exploring PR-42 and PR-43 simultaneously | Each uses unique session names, no data cross-contamination | should |
| IT-8 | Exploration with AI Web Pilot disabled | interact(execute_js) without Web Pilot toggle | execute_js calls fail with clear error "AI Web Pilot not enabled" | must |
| IT-9 | URL scheme validation | interact(navigate) with `javascript:alert(1)` | Navigation blocked (if Gasoline adds scheme validation per OI-1) or agent-side skill prevents it | should |
| IT-10 | Stored baseline staleness detection | Baseline saved 48 hours ago, threshold is 24 hours | Agent warns "baseline is stale (48h old, threshold 24h)" | should |

### 4.3 Performance Tests

| # | Test Case | Metric | Target | Priority |
|---|-----------|--------|--------|----------|
| PT-1 | Navigate to preview overhead | Gasoline overhead for `interact({action: "navigate"})` | < 2s (Gasoline overhead, actual page load depends on preview) | must |
| PT-2 | Session capture speed | `diff_sessions({session_action: "capture"})` | < 200ms | must |
| PT-3 | Session comparison speed | `diff_sessions({session_action: "compare"})` | < 500ms | must |
| PT-4 | Behavioral baseline comparison | `compare_baseline` | < 20ms | should |
| PT-5 | PR summary generation | `generate({format: "pr_summary"})` | < 300ms | must |
| PT-6 | Full exploration workflow | End-to-end from discover to report | < 15 minutes (agent-side bound) | must |
| PT-7 | execute_js interaction overhead | Per-interaction Gasoline overhead | < 100ms per execute_js call | should |
| PT-8 | Observe after each page visit | `observe({what: "errors"})` during exploration | < 50ms per observe call | should |

### 4.4 Edge Case Tests

| # | Edge Case | Input/Scenario | Expected Behavior | Priority |
|---|-----------|---------------|-------------------|----------|
| EC-1 | Preview not yet deployed | Navigate to URL, connection refused | Agent retries with exponential backoff up to 5 minutes, then reports "preview not ready" | must |
| EC-2 | Preview returns error at root | HTTP 500 at root URL | Agent captures error, reports it as a finding, stops exploration | must |
| EC-3 | Preview requires auth (no credentials) | 401/403 response or redirect to login | Agent reports "authentication required", stops | must |
| EC-4 | Extension disconnects mid-exploration | WebSocket connection drops during explore phase | Tool calls return timeout errors, agent captures partial results | should |
| EC-5 | Buffer overflow during exploration | 20 pages visited, 1000+ log entries generated | Agent processes telemetry incrementally per page to prevent eviction of early findings | should |
| EC-6 | Multiple concurrent explorations | Two agents, two PRs, shared server | Unique session names prevent data cross-contamination; shared buffers may interleave (known limitation) | should |
| EC-7 | Preview URL changes mid-exploration | Dynamic URL becomes invalid during exploration | Agent stops, captures partial results, reports partial findings | should |
| EC-8 | No baseline available | First exploration ever, no production URL access | Agent reports absolute findings only, notes "no baseline comparison available" | must |
| EC-9 | Stale baseline (7 days old) | Stored baseline created 7 days ago | Agent warns about staleness, proceeds with comparison but notes reduced reliability | should |
| EC-10 | Preview environment has CORS restrictions | Preview blocks cross-origin requests from Gasoline | Gasoline capture script runs in-page (not cross-origin), so CORS does not affect capture. If interact(execute_js) scripts make cross-origin requests, they are subject to browser CORS. Agent handles gracefully. | should |
| EC-11 | Very slow preview (30+ second load times) | Preview environment under heavy load | Per-page timeout (30s) fires, agent proceeds to next page, notes timeout | should |
| EC-12 | Preview serves single-page app (SPA) | All navigation is client-side routing | Agent uses execute_js for navigation instead of navigate, captures telemetry at each route change | should |
| EC-13 | Preview has anti-bot protection | CAPTCHA or Cloudflare challenge | Agent detects challenge page, reports "preview has anti-bot protection, cannot explore automatically" | should |

---

## 5. UAT Checklist (Human + AI)

> Step-by-step verification for a human working with an AI assistant. The AI executes MCP tool calls; the human observes browser behavior and confirms results.

### Prerequisites
- [ ] Gasoline server running: `./dist/gasoline --port 7890`
- [ ] Chrome extension installed and connected
- [ ] AI Web Pilot toggle ENABLED by human in extension settings
- [ ] A web application running locally at `http://localhost:3000` (simulates production/main branch)
- [ ] A modified version running at `http://localhost:3001` (simulates preview environment with a bug -- e.g., a console error on the dashboard page)
- [ ] Or a real preview deployment URL available for testing

### Step-by-Step Verification

| # | Step (AI executes) | Human Observes | Expected Result | Pass |
|---|-------------------|----------------|-----------------|------|
| UAT-1 | **Phase 1 - Discover:** Human provides preview URL to AI | Human tells AI: "explore http://localhost:3001" | AI acknowledges URL, prepares to explore | [ ] |
| UAT-2 | **Phase 2 - Baseline:** AI navigates to main branch: `{"tool":"interact","arguments":{"action":"navigate","url":"http://localhost:3000"}}` | Browser navigates to main app | Main branch app loads | [ ] |
| UAT-3 | AI captures baseline: `{"tool":"configure","arguments":{"action":"diff_sessions","session_action":"capture","name":"main-baseline"}}` | N/A | Baseline snapshot captured and saved | [ ] |
| UAT-4 | AI checks baseline for errors: `{"tool":"observe","arguments":{"what":"errors"}}` | No errors in main branch | Error list empty or only known pre-existing errors | [ ] |
| UAT-5 | **Phase 3 - Explore:** AI opens preview in new tab: `{"tool":"interact","arguments":{"action":"new_tab","url":"http://localhost:3001"}}` | New browser tab opens with preview app | Tab opened, tab_id returned, developer's tab unaffected | [ ] |
| UAT-6 | AI waits for page load: `{"tool":"observe","arguments":{"what":"page"}}` | Preview page loads in new tab | Page ready state reported | [ ] |
| UAT-7 | AI explores -- clicks navigation link: `{"tool":"interact","arguments":{"action":"execute_js","script":"document.querySelector('a[href=\"/dashboard\"]').click()"}}` | Browser navigates to dashboard in preview tab | Dashboard page loads (with intentional console error) | [ ] |
| UAT-8 | AI captures errors: `{"tool":"observe","arguments":{"what":"errors"}}` | Console error visible in DevTools | Error returned in observe response (e.g., "TypeError: Cannot read property 'data' of undefined") | [ ] |
| UAT-9 | AI checks performance: `{"tool":"observe","arguments":{"what":"performance"}}` | N/A | Performance metrics returned (load time, LCP, CLS) | [ ] |
| UAT-10 | AI captures preview snapshot: `{"tool":"configure","arguments":{"action":"diff_sessions","session_action":"capture","name":"preview-pr-test"}}` | N/A | Preview session snapshot captured | [ ] |
| UAT-11 | **Phase 4 - Compare:** AI compares sessions: `{"tool":"configure","arguments":{"action":"diff_sessions","session_action":"compare","compare_a":"main-baseline","compare_b":"preview-pr-test"}}` | N/A | Diff shows new error in preview not present in baseline, performance delta | [ ] |
| UAT-12 | AI checks accessibility: `{"tool":"observe","arguments":{"what":"accessibility"}}` | N/A | Accessibility findings returned (if any) | [ ] |
| UAT-13 | **Phase 5 - Report:** AI generates report: `{"tool":"generate","arguments":{"format":"pr_summary"}}` | N/A | Markdown report with preview URL, findings, regressions, performance comparison | [ ] |
| UAT-14 | Human reviews report content | Read generated markdown | Report includes: (1) preview URL explored, (2) pages visited, (3) new error found, (4) performance comparison, (5) clear severity classification | [ ] |
| UAT-15 | Human verifies report is PR-ready | Compare to expected PR comment format | Report can be directly posted as a PR comment with no additional formatting needed | [ ] |

### Data Leak UAT Verification

| # | Check | Method | Expected | Pass |
|---|-------|--------|----------|------|
| DL-UAT-1 | Preview URL auth token not in report | Use a preview URL with `?token=secret`, generate report | Token value redacted in all output | [ ] |
| DL-UAT-2 | execute_js does not return sensitive data | Run execute_js that clicks a button, check response | Response contains execution result, not page localStorage/sessionStorage | [ ] |
| DL-UAT-3 | Baseline snapshot free of production credentials | Inspect baseline snapshot data | No auth cookies, session tokens, or API keys in baseline | [ ] |
| DL-UAT-4 | Session diff does not expose combined secrets | Compare production baseline to preview, inspect diff | Diff shows structural differences (new errors, metric changes) not raw credential data | [ ] |
| DL-UAT-5 | Tab isolation prevents cross-tab data leakage | Open developer tab with auth session, explore preview in new tab | Preview exploration telemetry does not contain developer tab's auth data | [ ] |
| DL-UAT-6 | PR summary safe for public posting | Review generated markdown for any sensitive values | No internal URLs, no credentials, no PII, safe for public PR comment | [ ] |

### Regression Checks
- [ ] Existing `interact({action: "navigate"})` works independently of preview exploration workflow
- [ ] Existing `interact({action: "new_tab"})` works independently
- [ ] Existing `interact({action: "execute_js"})` works independently
- [ ] Existing `observe` tools (errors, network, performance, accessibility, page) work independently
- [ ] Existing `configure({action: "diff_sessions"})` works independently
- [ ] Existing `generate({format: "pr_summary"})` works independently
- [ ] AI Web Pilot toggle still required for execute_js (security gate not bypassed)
- [ ] Single-tab tracking isolation still functions correctly
- [ ] 4-tool constraint maintained -- no new tools added

---

## Sign-Off

| Area | Tester | Date | Pass/Fail |
|------|--------|------|-----------|
| Data Leak Analysis | | | |
| LLM Clarity | | | |
| Simplicity | | | |
| Code Tests | | | |
| UAT | | | |
| **Overall** | | | |
