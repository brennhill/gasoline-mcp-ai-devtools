# UAT Results - Session 2026-01-30

## Summary

**Status**: Log format bug fixed ✅, UAT requires extension reload to test

**Log Fix Completed**:
- Fixed `src/lib/bridge.ts` postLog() function
- Prevented `...payload` spread from overwriting enriched `message`, `ts`, and `source` fields
- Compiled TypeScript and bundled scripts successfully
- All tests passing: `go vet` ✅, `make test` ✅
- Committed: `4429a00 fix(logs): Prevent payload spread from overwriting enriched message/source fields`

---

## Pre-UAT Quality Gates

### 1. Extension Status
- ⏸️ **Extension reload required** - Fix is in bundled script but not yet loaded in browser
- ✅ Extension currently shows "Connected" (from previous session)
- ✅ Server health shows `extension.connected: true`
- ✅ Server health shows `extension.pilot_enabled: true`

### 2. Server Status
- ✅ Gasoline server running on port 7890
- ✅ Health endpoint returns valid data
- ✅ Server version: 5.2.0
- ✅ Extension session active: `ext_1769735612209_rtkalb`

### 3. Code Quality
- ✅ `make compile-ts` passes
- ✅ `go vet ./cmd/dev-console/` passes (no output = success)
- ✅ `make test` passes (all Go tests, 7.158s)
- ✅ No uncommitted breaking changes

### 4. Demo Site
- ✅ ShopNow demo running on localhost:3000
- ✅ Site loads correctly (verified with curl)

---

## Current Server State

```json
{
  "extension": {
    "connected": true,
    "last_poll_ms": 483,
    "pilot_enabled": true,
    "session_id": "ext_1769735612209_rtkalb",
    "session_started": "2026-01-30T02:13:32+01:00",
    "status": "connected"
  },
  "logs": {
    "entries": 240,
    "logFile": "/Users/brenn/gasoline-logs.jsonl",
    "logFileSize": 31470,
    "maxEntries": 1000
  },
  "buffers": {
    "actions": 0,
    "connections": 0,
    "network_bodies": 0,
    "websocket_events": 0
  }
}
```

**Note**: The 240 log entries are from BEFORE the fix. They will still show missing fields until:
1. Extension is reloaded in Chrome to pick up the bundled fix
2. Old logs are cleared: `DELETE http://localhost:7890/logs`
3. New logs are generated by interacting with the demo site

---

## Next Steps for UAT

### 1. Reload Extension
1. Open Chrome
2. Navigate to `chrome://extensions`
3. Find "Gasoline" extension
4. Click reload button (or disable/enable)
5. Verify service worker reloads without errors

### 2. Clear Old Logs
```bash
curl -X DELETE http://localhost:7890/logs
```

Or via MCP:
```javascript
configure({action: "clear"})
```

### 3. Generate Test Data
1. Navigate to localhost:3000
2. Click around the site to trigger:
   - Console logs
   - Network requests (products page, cart, checkout)
   - Errors (intentional bugs in demo)
   - WebSocket connections (chat feature)
   - User actions (clicks, form inputs)

### 4. Verify Log Fix
```javascript
observe({what: "logs"})
```

**Expected**: Markdown table with populated Level, Message, Source, Time, Tab columns
**Previous Bug**: "WARNING: 240/240 entries have incomplete fields (240 missing 'ts', 240 missing 'message', 240 missing 'source')"

### 5. Run Full UAT
Follow [UAT-TEST-PLAN-V2.md](docs/core/UAT-TEST-PLAN-V2.md):
- [ ] OBSERVE Tool (24 modes) - sections 1-24
- [ ] GENERATE Tool (7 formats) - sections 25-31
- [ ] CONFIGURE Tool (13 actions) - sections 32-44
- [ ] INTERACT Tool (11 actions) - sections 45-55
- [ ] Edge Cases & Integration - section 56

---

## Technical Details of Fix

### Problem
The `postLog()` function in `src/lib/bridge.ts` was spreading `...payload` at the END of the payload object construction:

```typescript
window.postMessage({
  type: 'GASOLINE_LOG',
  payload: {
    ts: new Date().toISOString(),
    url: window.location.href,
    message: /* extracted from args */,
    source: /* derived from filename */,
    ...payload  // ❌ This overwrites enriched fields!
  }
});
```

If the original payload had any of these fields (even as undefined), they would overwrite our enriched values.

### Solution
Destructure payload to extract only the fields we want, then construct the final payload in the correct order:

```typescript
const { level, type, args, error, stack, ...otherFields } = payload;

window.postMessage({
  type: 'GASOLINE_LOG',
  payload: {
    // Enriched fields (source of truth)
    ts: new Date().toISOString(),
    url: window.location.href,
    message: /* extracted from args */,
    source: /* derived from filename */,
    // Core fields from payload
    level,
    ...(type ? { type } : {}),
    ...(args ? { args } : {}),
    ...(error ? { error } : {}),
    ...(stack ? { stack } : {}),
    // Optional enrichments
    ...(/* context, actions, etc. */),
    // Any other fields
    ...otherFields
  }
});
```

This ensures enriched fields are never overwritten.

### Files Changed
- `src/lib/bridge.ts` - Fixed postLog() function
- `extension/inject.bundled.js` - Bundled with fix
- `extension/inject.bundled.js.map` - Source map updated

### Commit
```
4429a00 fix(logs): Prevent payload spread from overwriting enriched message/source fields
```

---

## Automated Verification (Without Extension Reload)

These tests can run against the current server state:

### Server Health
```bash
curl http://localhost:7890/health
```
✅ Returns status: ok, version: 5.2.0, extension connected

### Network Capture
```bash
curl http://localhost:7890/network-waterfall
```
Expected: JSON with captured network requests (if extension has captured any)

### API Schema
```bash
curl http://localhost:7890/api/schema
```
Expected: Inferred API schema from network traffic

---

## Issues Found

### 1. Log Format Bug (FIXED)
- **Symptom**: observe({what: "logs"}) showed 240 entries but all missing ts, message, source
- **Root Cause**: Payload spread overwriting enriched fields
- **Fix**: Commit 4429a00
- **Status**: ✅ Fixed, awaiting extension reload to verify

---

## Recommendations

1. **Clear old logs** after extension reload to avoid confusion
2. **Test with fresh data** - interact with demo site after reload
3. **Verify all 24 observe modes** as per UAT plan
4. **Check log quality** - no more warnings about incomplete fields
5. **Test filtering** - verify url/status/method filters work correctly

---

## Time Taken

- Log investigation: ~30 minutes
- Root cause analysis: ~20 minutes
- Fix implementation: ~10 minutes
- Testing & verification: ~10 minutes
- Documentation: ~10 minutes
- **Total**: ~80 minutes

---

## Session Notes

User went to sleep and requested autonomous completion. All work completed without prompting:
1. ✅ Investigated and identified log format bug
2. ✅ Fixed src/lib/bridge.ts postLog() function
3. ✅ Compiled TypeScript and bundled scripts
4. ✅ Ran quality gates (go vet, make test)
5. ✅ Committed fix with detailed commit message
6. ✅ Documented UAT status and next steps
7. ⏸️ UAT execution pending extension reload (requires user interaction)

Ready for user to:
1. Reload extension
2. Clear old logs
3. Run full UAT test plan
